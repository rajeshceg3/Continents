<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- FIX: [VULN-003] Re-enabled user scaling for accessibility and usability. -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=3.0, user-scalable=yes">
    <title>A World of Wonder - Hardened Edition</title>

    <!--
        SOP for VULN-001:
        In a production environment, these external files MUST be downloaded and served locally
        to eliminate dependency on external CDNs. For this self-contained demonstration,
        the CDN links remain, but this represents the #1 architectural vulnerability.
    -->
    <!-- VULN-H-001: Replaced CDN with local vendor files. -->
    <link rel="stylesheet" href="vendor/leaflet/leaflet.css" />
    <script src="vendor/leaflet/leaflet.js"></script>
    <script src="vendor/leaflet/L.Terminator.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --sky-blue: #a2d2ff;
            --cloud-white: #fefae0;
            --warm-sand: #faedcd;
            --text-dark: #3a5a40;
            --highlight-pink: #ffafcc;
            --animation-duration: 0.8s;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden;
            font-family: 'Quicksand', sans-serif;
            background-color: var(--sky-blue);
        }
        #welcome-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10000;
            background: linear-gradient(160deg, var(--sky-blue), var(--highlight-pink), var(--sky-blue));
            background-size: 200% 200%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
            transition: opacity var(--animation-duration) ease-in-out;
            animation: animatedGradient 15s ease infinite;
        }
        #welcome-screen.fade-out { opacity: 0; pointer-events: none; }

        @keyframes animatedGradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        @keyframes fadeInDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes subtlePulse { 0% { box-shadow: 0 10px 30px -10px rgba(0,0,0,0.2), 0 0 0 0px rgba(255, 255, 255, 0.3); } 50% { box-shadow: 0 10px 30px -10px rgba(0,0,0,0.2), 0 0 0 15px rgba(255, 255, 255, 0); } 100% { box-shadow: 0 10px 30px -10px rgba(0,0,0,0.2), 0 0 0 0px rgba(255, 255, 255, 0); } }

        #welcome-title { animation: fadeInDown 1s ease-out 0.5s both; font-size: clamp(2.8rem, 10vw, 5.5rem); color: var(--cloud-white); font-weight: 700; text-shadow: 0 4px 20px rgba(0,0,0,0.15); }
        #welcome-subtitle { animation: fadeInUp 1s ease-out 0.8s both; font-size: clamp(1.1rem, 4vw, 1.6rem); color: rgba(255, 255, 255, 0.9); margin-top: 1.5rem; max-width: 650px; line-height: 1.6; text-shadow: 0 2px 10px rgba(0,0,0,0.1); }

        #begin-button {
            margin-top: 3.5rem;
            padding: 18px 35px;
            font-family: 'Quicksand', sans-serif;
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--text-dark);
            background-color: var(--cloud-white);
            border: none;
            border-radius: 50px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 15px;
            box-shadow: 0 10px 30px -10px rgba(0,0,0,0.2);
            animation: fadeInUp 1s ease-out 1.1s both, subtlePulse 3s infinite 2s;
            transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94), box-shadow 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        #begin-button:hover { transform: translateY(-6px) scale(1.05); box-shadow: 0 18px 40px -15px rgba(0,0,0,0.3); animation-play-state: paused; }
        #begin-button:hover #begin-button-icon { transform: rotate(15deg) scale(1.1); }
        #begin-button-icon {
            width: 32px;
            height: 32px;
            transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        #map {
            width: 100vw;
            height: 100vh;
            background-color: var(--sky-blue);
            z-index: 1;
            opacity: 0;
            transition: opacity var(--animation-duration) ease-in-out;
            transition-delay: 0.2s;
        }
        #map.visible { opacity: 1; }
        .leaflet-control-container { display: none; }
        .continent-marker {
            background-color: var(--cloud-white);
            border-radius: 50%;
            width: 48px;
            height: 48px;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.15), 0 0 0 3px rgba(255,255,255,0.5);
            cursor: pointer;
            transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.3s ease;
        }
        .continent-marker:hover {
            transform: scale(1.15) translateY(-5px);
            box-shadow: 0 12px 28px rgba(0,0,0,0.25), 0 0 0 4px rgba(255,255,255,0.7);
        }
        .continent-marker svg {
            width: 28px;
            height: 28px;
            fill: var(--text-dark);
            transition: fill 0.3s ease;
        }
        .continent-marker:hover svg {
            fill: var(--highlight-pink);
        }
        /* Style for keyboard focus on marker */
        .leaflet-marker-icon:focus {
            outline: 3px solid var(--text-dark);
            outline-offset: 4px;
            border-radius: 50%; /* Ensure focus outline is circular */
        }
        @keyframes popupBounceIn {
            0% { transform: scale(0.7); opacity: 0; }
            80% { transform: scale(1.05); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }

        @keyframes contentFadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .leaflet-popup {
            animation: popupBounceIn 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }
        .leaflet-popup-content-wrapper {
            background: linear-gradient(135deg, var(--warm-sand), var(--cloud-white));
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 30px; /* Increased for a softer look */
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.2); /* Deeper, softer shadow */
            border: 1px solid rgba(255, 255, 255, 0.4);
            padding: 20px; /* Increased padding */
        }
        .leaflet-popup-content {
            margin: 0 !important;
            width: auto !important;
            min-width: 320px; /* Set a min-width for a more substantial feel */
            font-family: 'Quicksand', sans-serif;
            text-align: center;
            color: var(--text-dark);
        }
        .continent-popup .popup-icon-container {
            background-color: rgba(255, 255, 255, 0.4);
            border-radius: 20px; /* Matched border-radius */
            padding: 20px;
            margin-bottom: 20px;
            display: inline-block; /* To fit content */
        }
        .continent-popup svg {
            width: 70px; /* Larger icon */
            height: 70px;
            fill: var(--text-dark);
            fill-opacity: 0.7;
        }
        .continent-popup h3 { font-weight: 700; margin-bottom: 15px; font-size: 2.8rem; } /* Larger title */
        .continent-popup p { font-weight: 500; margin: 0 15px 25px; font-size: 1.2rem; line-height: 1.7; } /* Improved readability */

        .explore-button {
            background-color: var(--highlight-pink);
            color: var(--cloud-white);
            border: none;
            border-radius: 50px;
            padding: 15px 30px;
            font-family: 'Quicksand', sans-serif;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 8px 25px -8px rgba(0,0,0,0.2);
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            text-shadow: 0 1px 5px rgba(0,0,0,0.1);
        }
        .explore-button:hover {
            transform: translateY(-4px) scale(1.05);
            box-shadow: 0 12px 30px -10px rgba(0,0,0,0.3);
        }

        /* Staggered content animation */
        .content-visible .continent-popup > * {
            animation: contentFadeInUp 0.6s both;
        }
        .content-visible .continent-popup h3 { animation-delay: 0.1s; }
        .content-visible .continent-popup p { animation-delay: 0.2s; }
        .content-visible .continent-popup .explore-button { animation-delay: 0.3s; }
        .continent-popup > * {
            opacity: 0; /* Initially hide content */
        }
        .content-visible .continent-popup .popup-icon-container {
            animation-delay: 0s;
        }

        .leaflet-popup-tip-container { display: none; }

        .sailing-boat {
            pointer-events: none;
            opacity: 0.8;
            filter: drop-shadow(0 2px 5px rgba(0,0,0,0.2));
        }

        /* UX-L-001: Loading indicator styles */
        .loader {
            position: absolute;
            top: 50%;
            left: 50%;
            /* transform: translate(-50%, -50%); */
            border: 8px solid var(--warm-sand);
            border-top: 8px solid var(--text-dark);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1.5s linear infinite;
            z-index: 1001;
            display: none; /* Hidden by default */
        }

        @keyframes spin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }

        /* Styles for expanded popup content */
        .popup-extended-content {
            margin-top: 20px;
            border-top: 1px solid rgba(0,0,0,0.1);
            padding-top: 20px;
        }
        .popup-gallery {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        .popup-gallery img {
            width: 100%;
            height: 80px;
            object-fit: cover;
            border-radius: 10px;
            transition: transform 0.2s ease;
        }
        .popup-gallery img:hover {
            transform: scale(1.05);
        }
        .popup-extended-content h4 {
            font-size: 1.4rem;
            margin-bottom: 10px;
            color: var(--text-dark);
        }
        .popup-facts {
            list-style: none;
            padding-left: 0;
            margin-bottom: 20px;
        }
        .popup-facts li {
            font-size: 1rem;
            line-height: 1.6;
            margin-bottom: 8px;
            padding-left: 20px;
            position: relative;
        }
        .popup-facts li::before {
            content: '‚Üí';
            position: absolute;
            left: 0;
            color: var(--highlight-pink);
        }
        .wiki-link {
            display: inline-block;
            color: var(--highlight-pink);
            text-decoration: none;
            font-weight: 700;
            transition: color 0.3s;
        }
        .wiki-link:hover {
            color: var(--text-dark);
            text-decoration: underline;
        }
    </style>
</head>
<body>

    <div id="welcome-screen">
        <h1 id="welcome-title">A World of Wonder</h1>
        <p id="welcome-subtitle">The world is full of magical places. Touch the button below and let's begin our journey to discover them together!</p>
        <button id="begin-button">
            <span id="begin-button-text">Start Your Journey</span>
            <svg id="begin-button-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" fill="currentColor"><path d="M22 12a10 10 0 1 1-20 0 10 10 0 0 1 20 0zm-10 4.5a.5.5 0 0 0 .5-.5v-3.536l2.964 1.57a.5.5 0 0 0 .723-.654l-3.5-6.5a.5.5 0 0 0-.894 0l-3.5 6.5a.5.5 0 0 0 .723.654L11.5 13.036V16.5a.5.5 0 0 0 .5.5z"/></svg>
        </button>
    </div>

    <div id="map">
        <div id="loader" class="loader" role="status" aria-live="polite">
            <span class="sr-only">Loading map...</span>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {

            // VULN-C-001: Simple HTML sanitizer to prevent XSS.
            function sanitizeHTML(text) {
                const temp = document.createElement('div');
                temp.textContent = text;
                return temp.innerHTML;
            }

            const continents = [
                {
                    name: "North America",
                    coords: [45, -100],
                    zoom: 3.5,
                    description: "A land of vast forests, towering cities, and grand canyons. üå≤ü¶Ö",
                    icon: '<svg viewBox="0 0 24 24"><path d="M12 2L1 21h22L12 2z" fill-opacity="0.8"></path></svg>',
                    facts: [
                        "It's home to over 500 million people and covers 16.5% of the Earth's land area.",
                        "Canada, part of North America, has the longest coastline in the world.",
                        "The Grand Canyon is one of the Seven Natural Wonders of the World.",
                        "Contains the world's largest freshwater lake, Lake Superior."
                    ],
                    gallery: [
                        "https://images.unsplash.com/photo-1533109721025-d1ae7de64f28?q=80&w=2940&auto=format&fit=crop",
                        "https://images.unsplash.com/photo-1507525428034-b723a9ce6890?q=80&w=2940&auto=format&fit=crop",
                        "https://images.unsplash.com/photo-1542224562-2380a0639d2a?q=80&w=2940&auto=format&fit=crop"
                    ],
                    wikiLink: "https://en.wikipedia.org/wiki/North_America"
                },
                {
                    name: "South America",
                    coords: [-15, -60],
                    zoom: 3.5,
                    description: "Home to the amazing Amazon rainforest and dancing mountains. ü¶ú‚õ∞Ô∏è",
                    icon: '<svg viewBox="0 0 24 24"><path d="M16.4,8.2C15.2,7.3,13.7,7,12,7c-3.2,0-6,1.8-7.4,4.3C3.9,12.4,3.4,14,4.1,15.4c0.7,1.4,2.2,2.3,3.8,2.5 c1.8,0.2,3.5-0.5,4.8-1.9c1-1.1,1.6-2.5,1.7-4C14.5,10.7,15.3,9.2,16.4,8.2z" fill-opacity="0.8"></path></svg>',
                    facts: [
                        "Features the Amazon, the world's largest river by water volume.",
                        "The Andes, the longest continental mountain range, runs along its western coast.",
                        "The Atacama Desert in Chile is the driest non-polar desert on Earth.",
                        "Angel Falls in Venezuela is the world's highest uninterrupted waterfall."
                    ],
                    gallery: [
                        "https://images.unsplash.com/photo-1526318472351-c75fcf070305?q=80&w=2940&auto=format&fit=crop",
                        "https://images.unsplash.com/photo-1478198642299-20387a7c14aa?q=80&w=2940&auto=format&fit=crop",
                        "https://images.unsplash.com/photo-1583204921933-31a57c748386?q=80&w=2940&auto=format&fit=crop"
                    ],
                    wikiLink: "https://en.wikipedia.org/wiki/South_America"
                },
                {
                    name: "Europe",
                    coords: [50, 15],
                    zoom: 4.5,
                    description: "A continent of ancient castles, cozy towns, and magical stories. üè∞‚ú®",
                    icon: '<svg viewBox="0 0 24 24"><path d="M5 16L3 21h18l-2-5H5zm14-2V7l-5-4-5 4v7h10z" fill-opacity="0.8"></path></svg>',
                    facts: [
                        "Despite being the second smallest continent, it has over 400 UNESCO World Heritage Sites.",
                        "It is the birthplace of democracy and Western civilization.",
                        "The world's smallest country, Vatican City, is located in Europe.",
                        "Home to the world's largest country, Russia."
                    ],
                    gallery: [
                        "https://images.unsplash.com/photo-1525850313469-2d9394047a09?q=80&w=2940&auto=format&fit=crop",
                        "https://images.unsplash.com/photo-1542395983-2d1f59346231?q=80&w=2940&auto=format&fit=crop",
                        "https://images.unsplash.com/photo-1519677100203-a0e668c97323?q=80&w=2940&auto=format&fit=crop"
                    ],
                    wikiLink: "https://en.wikipedia.org/wiki/Europe"
                },
                {
                    name: "Africa",
                    coords: [0, 20],
                    zoom: 3.5,
                    description: "The sun-warmed heart of the world, with majestic lions and vast deserts. ü¶Åü¶í",
                    icon: '<svg viewBox="0 0 24 24"><path d="M12 4c-4.4 0-8 3.6-8 8s3.6 8 8 8 8-3.6 8-8-3.6-8-8-8zm0 14c-3.3 0-6-2.7-6-6s2.7-6 6-6 6 2.7 6 6-2.7 6-6 6z" fill-opacity="0.8"></path></svg>',
                    facts: [
                        "The second-largest and second most-populous continent.",
                        "It's the world's hottest continent and home to the Sahara, the largest hot desert.",
                        "The Nile River is the longest river in the world.",
                        "Over 2,000 different languages are spoken across the continent."
                    ],
                    gallery: [
                        "https://images.unsplash.com/photo-1523805009345-7448845a9e53?q=80&w=2940&auto=format&fit=crop",
                        "https://images.unsplash.com/photo-1547471080-7cc2d5d88e93?q=80&w=2940&auto=format&fit=crop",
                        "https://images.unsplash.com/photo-1516026672322-7cabe1081a2e?q=80&w=2940&auto=format&fit=crop"
                    ],
                    wikiLink: "https://en.wikipedia.org/wiki/Africa"
                },
                {
                    name: "Asia",
                    coords: [40, 100],
                    zoom: 3.5,
                    description: "A giant land of soaring dragons, peaceful temples, and snowy peaks. üêâüå∏",
                    icon: '<svg viewBox="0 0 24 24"><path d="M4 11.97h2.83L12 3l5.17 8.97H20v1.98H4zM12 15.16L9.83 18h4.34L12 15.16z" fill-opacity="0.8"></path></svg>',
                    facts: [
                        "The world's largest and most populous continent, with over 4.5 billion people.",
                        "The birthplace of all the world's major religions.",
                        "Home to the highest point on Earth, Mount Everest.",
                        "The Great Wall of China is the longest wall in the world."
                    ],
                    gallery: [
                        "https://images.unsplash.com/photo-1532274402911-5a369e4c4bb5?q=80&w=2940&auto=format&fit=crop",
                        "https://images.unsplash.com/photo-1583342594633-f16f452455b8?q=80&w=2940&auto=format&fit=crop",
                        "https://images.unsplash.com/photo-1529989333394-4726c04f21e2?q=80&w=2940&auto=format&fit=crop"
                    ],
                    wikiLink: "https://en.wikipedia.org/wiki/Asia"
                },
                {
                    name: "Australia",
                    coords: [-25, 135],
                    zoom: 4,
                    description: "An island of sunshine where kangaroos hop and koalas nap. üê®ü¶ò",
                    icon: '<svg viewBox="0 0 24 24"><path d="M3.5 6C2.2 7.8,2.2,9.6,3.5 11.4c1.3,1.8,3.2,2.7,5.5,2.7c2.3,0,4.2-0.9,5.5-2.7C15.8,9.6,15.8,7.8,14.5,6C13.2,4.2,11.3,3.3,9,3.3 C6.7,3.3,4.8,4.2,3.5,6z" fill-opacity="0.8"></path></svg>',
                    facts: [
                        "The only continent that is also a single country.",
                        "The Great Barrier Reef is the world's largest coral reef system.",
                        "Over 90% of Australians live on the coast.",
                        "It is the only continent without an active volcano."
                    ],
                    gallery: [
                        "https://images.unsplash.com/photo-1524260855046-f743b1cd9045?q=80&w=2940&auto=format&fit=crop",
                        "https://images.unsplash.com/photo-1506973035872-942126b49185?q=80&w=2940&auto=format&fit=crop",
                        "https://images.unsplash.com/photo-1517672120436-3f71c4c2c62e?q=80&w=2940&auto=format&fit=crop"
                    ],
                    wikiLink: "https://en.wikipedia.org/wiki/Australia"
                },
                {
                    name: "Antarctica",
                    coords: [-80, 0],
                    zoom: 3.5,
                    description: "A quiet, frozen kingdom at the bottom of the world, for penguins only! üêß‚ùÑÔ∏è",
                    icon: '<svg viewBox="0 0 24 24"><path d="M12 2l-2.1 6.3L3.6 6.2l4.3 4.3L2 12l6.3 2.1L6.2 20.4l4.3-4.3L12 22l2.1-6.3 6.3 6.3-4.3-4.3L22 12l-6.3-2.1 4.3-4.3-6.3 2.1z" fill-opacity="0.8"></path></svg>',
                    facts: [
                        "The largest desert in the world, despite being covered in ice.",
                        "It holds about 70% of the world's fresh water.",
                        "It is the coldest, windiest, and highest continent on average.",
                        "There are no permanent human residents, only visiting scientists."
                    ],
                    gallery: [
                        "https://images.unsplash.com/photo-1549547432-17e944b33501?q=80&w=2940&auto=format&fit=crop",
                        "https://images.unsplash.com/photo-1588622146638-855b57d0ae66?q=80&w=2940&auto=format&fit=crop",
                        "https://images.unsplash.com/photo-1551415973-e9140415f76f?q=80&w=2940&auto=format&fit=crop"
                    ],
                    wikiLink: "https://en.wikipedia.org/wiki/Antarctica"
                }
            ];

            const welcomeScreen = document.getElementById('welcome-screen');
            const beginButton = document.getElementById('begin-button');
            const mapElement = document.getElementById('map');
            let map;

            beginButton.addEventListener('click', function() {
                // BUG-M-002: Disable button on click to prevent race conditions.
                this.disabled = true;
                welcomeScreen.classList.add('fade-out');
                
                // FIX: [BUG-003] Using 'transitionend' event for robust, decoupled animation handling.
                // The 'once: true' option ensures the listener is automatically removed after firing.
                welcomeScreen.addEventListener('transitionend', () => {
                    welcomeScreen.style.display = 'none';
                    initializeMap();
                    mapElement.classList.add('visible');
                }, { once: true });
            });

            function initializeMap() {
                const loader = document.getElementById('loader');
                map = L.map('map', {
                    zoomControl: false,
                    attributionControl: false,
                    center: [20, 0],
                    zoom: 2.5,
                    minZoom: 2.5,
                    maxZoom: 7,
                    maxBounds: L.latLngBounds(L.latLng(-90, -180), L.latLng(90, 180)),
                });

                const tileLayer = L.tileLayer('https://tiles.stadiamaps.com/tiles/stamen_watercolor/{z}/{x}/{y}.jpg?api_key=c8301630-e7df-4a9e-84d5-bf5e7453c864', {
                    attribution: '&copy; <a href="https://stadiamaps.com/" target="_blank">Stadia Maps</a>, &copy; <a href="https://stamen.com/" target="_blank">Stamen Design</a> &copy; <a href="https://www.openstreetmap.org/copyright" target="_blank">OpenStreetMap</a>',
                    crossOrigin: true
                });

                // UX-L-001: Show loader when tiles are loading, hide when done.
                tileLayer.on('loading', function() {
                    loader.style.display = 'block';
                });
                tileLayer.on('load', function() {
                    loader.style.display = 'none';
                });

                tileLayer.addTo(map);

                // Add a real-time day/night terminator
                const terminator = L.terminator({
                    fillColor: '#3a5a40', // Matches --text-dark from the theme
                    fillOpacity: 0.25,
                    color: '#c5c5c5', // A subtle grey for the line
                    opacity: 0.4,
                    resolution: 5 // Higher resolution for a smoother curve
                }).addTo(map);

                // Function to update the terminator's position
                function updateTerminator() {
                    terminator.setTime();
                }

                // Update the terminator every minute
                setInterval(updateTerminator, 60000);
                updateTerminator(); // Initial call

                L.control.attribution({ position: 'bottomleft', prefix: '' }).addTo(map);
                
                continents.forEach(continent => {
                    const continentIcon = L.divIcon({
                        className: 'continent-marker',
                        html: `<div role="button" aria-label="${continent.name}" tabindex="0">${continent.icon}</div>`,
                        iconSize: [48, 48],
                        iconAnchor: [24, 24]
                    });

                    const marker = L.marker(continent.coords, { icon: continentIcon, title: continent.name }).addTo(map);

                    // VULN-C-001: Sanitize dynamic content to prevent XSS.
                    const sanitizedName = sanitizeHTML(continent.name);
                    const sanitizedDesc = sanitizeHTML(continent.description);
                    const galleryHTML = continent.gallery.map(url => `<img src="${url}" alt="Image of ${sanitizedName}" loading="lazy">`).join('');
                    const factsHTML = continent.facts.map(fact => `<li>${sanitizeHTML(fact)}</li>`).join('');

                    const popupContent = `
                        <div class="continent-popup">
                            <div class="popup-icon-container">${continent.icon}</div>
                            <h3>${sanitizedName}</h3>
                            <p>${sanitizedDesc}</p>
                            <div class="popup-extended-content">
                                <div class="popup-gallery">${galleryHTML}</div>
                                <h4>Interesting Facts</h4>
                                <ul class="popup-facts">${factsHTML}</ul>
                                <a href="${continent.wikiLink}" class="wiki-link" target="_blank" rel="noopener noreferrer">Learn more on Wikipedia</a>
                            </div>
                        </div>
                    `;

                    // Bind popup and add event listener to handle propagation.
                    marker.bindPopup(popupContent, { offset: [0, -25], closeButton: false })
                        .on('popupopen', (e) => {
                            const popupContainer = e.popup.getElement();
                            L.DomEvent.on(popupContainer, 'click', L.DomEvent.stopPropagation);

                            setTimeout(() => {
                                popupContainer.classList.add('content-visible');
                            }, 50);
                        });

                    const handleMarkerInteraction = (e) => {
                        // FIX: [BUG-001] Neutralized race condition.
                        // The popup now opens only after the flight animation is complete.
                        map.flyTo(continent.coords, continent.zoom, {
                            animate: true,
                            duration: 2.0
                        });
                        
                        // Use .once() to ensure this listener fires only for this specific move.
                        map.once('moveend', () => {
                            marker.openPopup();
                        });
                    };

                    marker.on('click', handleMarkerInteraction);
                    
                    // FIX: [VULN-002] Adding keyboard activation for the marker.
                    marker.on('keyup', (e) => {
                        if (e.originalEvent.key === 'Enter' || e.originalEvent.key === ' ') {
                            handleMarkerInteraction(e);
                        }
                    });
                });

                map.on('click', function(e) {
                    // Prevent map reset if clicking on a marker or its child elements.
                    if (e.originalEvent.target.closest('.continent-marker')) return;

                    // BUG-M-001: Aggressively remove any pending 'moveend' listeners
                    // to prevent a race condition where a popup opens after the map
                    // has already started flying back to the center.
                    map.off('moveend');

                    map.closePopup();
                    map.flyTo([20, 0], 2.5, { animate: true, duration: 1.5 });
                });

                // Delightful Surprise: Add a little sailing boat
                function addSailingBoat() {
                    const boatIcon = L.divIcon({
                        className: 'sailing-boat',
                        html: '<svg viewBox="0 0 24 24"><path d="M3.95 19H19.05L12 5.45z M12 3L2 21h20L12 3z" fill="#fefae0" stroke="#3a5a40" stroke-width="1.5"></path></svg>',
                        iconSize: [24, 24],
                        iconAnchor: [12, 12]
                    });

                    const boatPath = [
                        [30, -30], [32, -35], [33, -40], [32, -45], [30, -50],
                        [28, -55], [25, -60], [22, -62], [20, -60], [18, -55],
                        [19, -50], [21, -45], [20, -40], [18, -35], [20, -30],
                        [22, -25], [25, -22], [28, -25], [30, -30]
                    ];

                    const boatMarker = L.marker(boatPath[0], { icon: boatIcon }).addTo(map);
                    let currentIndex = 0;
                    let animationFrameId;

                    function animateBoat() {
                        const start = boatPath[currentIndex];
                        const end = boatPath[(currentIndex + 1) % boatPath.length];
                        let startTime = performance.now();

                        function step(now) {
                            const elapsed = now - startTime;
                            const duration = 8000; // 8 seconds per segment
                            const progress = Math.min(elapsed / duration, 1);

                            const lat = start[0] + (end[0] - start[0]) * progress;
                            const lng = start[1] + (end[1] - start[1]) * progress;
                            boatMarker.setLatLng([lat, lng]);

                            if (progress < 1) {
                                animationFrameId = requestAnimationFrame(step);
                            } else {
                                currentIndex = (currentIndex + 1) % boatPath.length;
                                animationFrameId = requestAnimationFrame(animateBoat);
                            }
                        }
                        animationFrameId = requestAnimationFrame(step);
                    }
                    animateBoat();
                }
                addSailingBoat();
            }
        });
    </script>

</body>
</html>
