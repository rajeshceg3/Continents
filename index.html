<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- FIX: [VULN-003] Re-enabled user scaling for accessibility and usability. -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=3.0, user-scalable=yes">
    <title>A World of Wonder - Hardened Edition</title>

    <!--
        SOP for VULN-001:
        In a production environment, these external files MUST be downloaded and served locally
        to eliminate dependency on external CDNs. For this self-contained demonstration,
        the CDN links remain, but this represents the #1 architectural vulnerability.
    -->
    <!-- VULN-H-001: Replaced CDN with local vendor files. -->
    <link rel="stylesheet" href="vendor/leaflet/leaflet.css" />
    <script src="vendor/leaflet/leaflet.js"></script>
    <script src="vendor/leaflet/L.Terminator.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:ital,wght@0,600;0,700;1,600&display=swap" rel="stylesheet">

    <style>
        :root {
            /* Palette - Stripe/Premium Tech Vibe */
            --primary: #0A2540;     /* Deep Navy */
            --accent: #635BFF;      /* Vibrant Violet */
            --accent-hover: #5851E5;
            --success: #00D4FF;     /* Teal/Cyan */
            --text-main: #425466;   /* Slate */
            --text-light: #697386;  /* Light Slate */
            --bg-light: #F6F9FC;    /* Pale Gray */
            --surface: #FFFFFF;     /* White */
            --shadow-sm: 0 2px 5px -1px rgba(50,50,93,0.25), 0 1px 3px -1px rgba(0,0,0,0.3);
            --shadow-md: 0 6px 12px -2px rgba(50,50,93,0.25), 0 3px 7px -3px rgba(0,0,0,0.3);
            --shadow-lg: 0 13px 27px -5px rgba(50,50,93,0.25), 0 8px 16px -8px rgba(0,0,0,0.3);

            --font-ui: 'Inter', sans-serif;
            --font-heading: 'Playfair Display', serif;

            --animation-duration: 0.6s;
            --ease-out-quart: cubic-bezier(0.165, 0.84, 0.44, 1);
            --ease-elastic: cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden;
            font-family: var(--font-ui);
            background-color: var(--primary);
            color: var(--text-main);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        /* --- Layout Shells --- */
        #app-shell {
            position: relative;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        /* --- Welcome Screen --- */
        #welcome-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10000;
            background: linear-gradient(135deg, var(--primary) 0%, #1e3a8a 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 40px;
            transition: transform 1s var(--ease-out-quart), opacity 0.8s ease;
        }

        #welcome-screen::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: radial-gradient(circle at 50% 50%, rgba(99, 91, 255, 0.15) 0%, transparent 70%);
            pointer-events: none;
        }

        #welcome-screen.fade-out {
            transform: translateY(-100%);
            pointer-events: none;
        }

        #welcome-title {
            font-family: var(--font-heading);
            font-size: clamp(3rem, 10vw, 6rem);
            color: var(--surface);
            font-weight: 700;
            margin-bottom: 1.5rem;
            letter-spacing: -0.02em;
            opacity: 0;
            transform: translateY(30px);
            animation: heroFadeIn 1s var(--ease-out-quart) forwards 0.2s;
        }

        #welcome-subtitle {
            font-size: clamp(1.1rem, 4vw, 1.4rem);
            color: rgba(255, 255, 255, 0.8);
            max-width: 600px;
            line-height: 1.6;
            margin-bottom: 4rem;
            font-weight: 300;
            opacity: 0;
            transform: translateY(20px);
            animation: heroFadeIn 1s var(--ease-out-quart) forwards 0.4s;
        }

        #begin-button {
            padding: 16px 48px;
            font-family: var(--font-ui);
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--surface);
            background-color: var(--accent);
            border: none;
            border-radius: 100px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 4px 6px rgba(50, 50, 93, 0.11), 0 1px 3px rgba(0, 0, 0, 0.08);
            transition: all 0.3s var(--ease-out-quart);
            opacity: 0;
            transform: translateY(20px);
            animation: heroFadeIn 1s var(--ease-out-quart) forwards 0.6s;
        }

        #begin-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 7px 14px rgba(50, 50, 93, 0.1), 0 3px 6px rgba(0, 0, 0, 0.08);
            background-color: var(--accent-hover);
        }

        @keyframes heroFadeIn {
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- Map & Markers --- */
        #map {
            width: 100vw;
            height: 100vh;
            background-color: #f0f0f0;
            z-index: 1;
        }

        /* Filter to make Stamen Watercolor look like a technical blueprint */
        .leaflet-tile-pane {
            filter: grayscale(100%) contrast(1.1) brightness(1.1);
        }

        /* Overlay a blue tint */
        #map::after {
            content: '';
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(10, 37, 64, 0.05); /* Slight navy tint */
            pointer-events: none;
            z-index: 400; /* Above tiles, below markers */
        }

        .leaflet-control-container { display: none; }

        /* Pulsing Beacon Marker */
        .continent-marker {
            background: transparent;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .beacon {
            position: relative;
            width: 24px;
            height: 24px;
            background: var(--accent);
            border-radius: 50%;
            box-shadow: 0 0 0 4px rgba(255, 255, 255, 0.3);
            display: flex;
            justify-content: center;
            align-items: center;
            transition: transform 0.3s var(--ease-elastic);
            cursor: pointer;
        }

        .beacon::before, .beacon::after {
            content: '';
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            border-radius: 50%;
            border: 1px solid var(--accent);
            width: 100%; height: 100%;
            opacity: 0;
            animation: ripple 2s infinite cubic-bezier(0, 0.2, 0.8, 1);
        }

        .beacon::after {
            animation-delay: 1s;
        }

        .beacon-icon {
            width: 14px;
            height: 14px;
            fill: white;
            z-index: 2;
        }

        .continent-marker:hover .beacon {
            transform: scale(1.2);
            background: var(--success);
            box-shadow: 0 0 20px var(--success);
        }

        .continent-marker:hover .beacon::before,
        .continent-marker:hover .beacon::after {
            border-color: var(--success);
        }

        @keyframes ripple {
            0% { width: 100%; height: 100%; opacity: 1; border-width: 2px; }
            100% { width: 300%; height: 300%; opacity: 0; border-width: 0px; }
        }

        /* --- Desktop Sidebar --- */
        #sidebar {
            position: absolute;
            top: 20px;
            left: 20px;
            bottom: 20px;
            width: 420px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 24px;
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            transform: translateX(-120%);
            transition: transform 0.6s var(--ease-out-quart);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        #sidebar.active {
            transform: translateX(0);
        }

        /* --- Mobile Bottom Sheet --- */
        #bottom-sheet {
            position: absolute;
            left: 0;
            right: 0;
            bottom: 0;
            height: 85vh;
            background: var(--surface);
            border-radius: 24px 24px 0 0;
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            transform: translateY(110%);
            transition: transform 0.5s var(--ease-out-quart);
            display: flex;
            flex-direction: column;
        }

        #bottom-sheet.active {
            transform: translateY(0);
        }

        @media (min-width: 769px) {
            #bottom-sheet { display: none; }
        }
        @media (max-width: 768px) {
            #sidebar { display: none; }
        }

        /* --- Content Styling --- */
        .content-header {
            padding: 32px 32px 16px;
        }

        .content-header h2 {
            font-family: var(--font-heading);
            font-size: 2.5rem;
            color: var(--primary);
            margin-bottom: 8px;
        }

        .content-header p {
            font-size: 1.1rem;
            color: var(--text-light);
            line-height: 1.5;
        }

        .content-body {
            padding: 0 32px 32px;
            overflow-y: auto;
            flex: 1;
        }

        .fact-card {
            background: var(--bg-light);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            border-left: 4px solid var(--accent);
        }

        .fact-card p {
            font-size: 0.95rem;
            color: var(--text-main);
            line-height: 1.6;
        }

        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin: 24px 0;
        }

        .gallery-grid img {
            width: 100%;
            height: 120px;
            object-fit: cover;
            border-radius: 12px;
            transition: transform 0.3s ease;
        }

        .gallery-grid img:hover {
            transform: scale(1.03);
        }

        .gallery-grid img:first-child {
            grid-column: span 2;
            height: 180px;
        }

        .close-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.05);
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .close-btn:hover { background: rgba(0,0,0,0.1); }
        .close-btn svg { width: 16px; height: 16px; fill: var(--text-main); }

        /* Loader */
        .loader {
            position: absolute;
            top: 50%; left: 50%;
            width: 40px; height: 40px;
            border: 3px solid rgba(99, 91, 255, 0.2);
            border-radius: 50%;
            border-top-color: var(--accent);
            animation: spin 1s ease-in-out infinite;
            z-index: 500;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); border: 0; }
    </style>
</head>
<body>

    <div id="welcome-screen">
        <h1 id="welcome-title">A World of Wonder</h1>
        <p id="welcome-subtitle">The world is full of magical places. Touch the button below and let's begin our journey to discover them together!</p>
        <button id="begin-button">
            <span id="begin-button-text">Start Your Journey</span>
            <svg id="begin-button-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 14.5v-9l6 4.5-6 4.5z"/></svg>
        </button>
    </div>

    <div id="app-shell">
        <div id="map">
            <div id="loader" class="loader" role="status" aria-live="polite">
                <span class="sr-only">Loading map...</span>
            </div>
        </div>

        <aside id="sidebar" role="complementary" aria-hidden="true">
            <div class="content-header">
                <button class="close-btn" aria-label="Close details">
                    <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                </button>
                <h2 id="sidebar-title">Continent Name</h2>
                <p id="sidebar-desc">A brief description goes here.</p>
            </div>
            <div class="content-body" id="sidebar-content">
                <!-- Dynamic Content Injected Here -->
            </div>
        </aside>

        <section id="bottom-sheet" role="complementary" aria-hidden="true">
            <div class="content-header">
                <button class="close-btn" aria-label="Close details" style="top: 16px; right: 16px;">
                    <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                </button>
                <h2 id="sheet-title">Continent Name</h2>
                <p id="sheet-desc">A brief description goes here.</p>
            </div>
            <div class="content-body" id="sheet-content">
                <!-- Dynamic Content Injected Here -->
            </div>
        </section>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {

            // VULN-C-001: Simple HTML sanitizer to prevent XSS.
            function sanitizeHTML(text) {
                const temp = document.createElement('div');
                temp.textContent = text;
                return temp.innerHTML;
            }

            const continents = [
                {
                    name: "North America",
                    coords: [45, -100],
                    zoom: 3.5,
                    description: "A land of vast forests, towering cities, and grand canyons. üå≤ü¶Ö",
                    icon: '<svg viewBox="0 0 24 24"><path d="M12 2L1 21h22L12 2z" fill-opacity="0.8"></path></svg>',
                    facts: [
                        "It's home to over 500 million people and covers 16.5% of the Earth's land area.",
                        "Canada, part of North America, has the longest coastline in the world.",
                        "The Grand Canyon is one of the Seven Natural Wonders of the World.",
                        "Contains the world's largest freshwater lake, Lake Superior."
                    ],
                    gallery: [
                        "https://images.unsplash.com/photo-1533109721025-d1ae7de64f28?q=80&w=2940&auto=format&fit=crop",
                        "https://images.unsplash.com/photo-1507525428034-b723a9ce6890?q=80&w=2940&auto=format&fit=crop",
                        "https://images.unsplash.com/photo-1542224562-2380a0639d2a?q=80&w=2940&auto=format&fit=crop"
                    ],
                    wikiLink: "https://en.wikipedia.org/wiki/North_America"
                },
                {
                    name: "South America",
                    coords: [-15, -60],
                    zoom: 3.5,
                    description: "Home to the amazing Amazon rainforest and dancing mountains. ü¶ú‚õ∞Ô∏è",
                    icon: '<svg viewBox="0 0 24 24"><path d="M16.4,8.2C15.2,7.3,13.7,7,12,7c-3.2,0-6,1.8-7.4,4.3C3.9,12.4,3.4,14,4.1,15.4c0.7,1.4,2.2,2.3,3.8,2.5 c1.8,0.2,3.5-0.5,4.8-1.9c1-1.1,1.6-2.5,1.7-4C14.5,10.7,15.3,9.2,16.4,8.2z" fill-opacity="0.8"></path></svg>',
                    facts: [
                        "Features the Amazon, the world's largest river by water volume.",
                        "The Andes, the longest continental mountain range, runs along its western coast.",
                        "The Atacama Desert in Chile is the driest non-polar desert on Earth.",
                        "Angel Falls in Venezuela is the world's highest uninterrupted waterfall."
                    ],
                    gallery: [
                        "https://images.unsplash.com/photo-1526318472351-c75fcf070305?q=80&w=2940&auto=format&fit=crop",
                        "https://images.unsplash.com/photo-1478198642299-20387a7c14aa?q=80&w=2940&auto=format&fit=crop",
                        "https://images.unsplash.com/photo-1583204921933-31a57c748386?q=80&w=2940&auto=format&fit=crop"
                    ],
                    wikiLink: "https://en.wikipedia.org/wiki/South_America"
                },
                {
                    name: "Europe",
                    coords: [50, 15],
                    zoom: 4.5,
                    description: "A continent of ancient castles, cozy towns, and magical stories. üè∞‚ú®",
                    icon: '<svg viewBox="0 0 24 24"><path d="M5 16L3 21h18l-2-5H5zm14-2V7l-5-4-5 4v7h10z" fill-opacity="0.8"></path></svg>',
                    facts: [
                        "Despite being the second smallest continent, it has over 400 UNESCO World Heritage Sites.",
                        "It is the birthplace of democracy and Western civilization.",
                        "The world's smallest country, Vatican City, is located in Europe.",
                        "Home to the world's largest country, Russia."
                    ],
                    gallery: [
                        "https://images.unsplash.com/photo-1525850313469-2d9394047a09?q=80&w=2940&auto=format&fit=crop",
                        "https://images.unsplash.com/photo-1542395983-2d1f59346231?q=80&w=2940&auto=format&fit=crop",
                        "https://images.unsplash.com/photo-1519677100203-a0e668c97323?q=80&w=2940&auto=format&fit=crop"
                    ],
                    wikiLink: "https://en.wikipedia.org/wiki/Europe"
                },
                {
                    name: "Africa",
                    coords: [0, 20],
                    zoom: 3.5,
                    description: "The sun-warmed heart of the world, with majestic lions and vast deserts. ü¶Åü¶í",
                    icon: '<svg viewBox="0 0 24 24"><path d="M12 4c-4.4 0-8 3.6-8 8s3.6 8 8 8 8-3.6 8-8-3.6-8-8-8zm0 14c-3.3 0-6-2.7-6-6s2.7-6 6-6 6 2.7 6 6-2.7 6-6 6z" fill-opacity="0.8"></path></svg>',
                    facts: [
                        "The second-largest and second most-populous continent.",
                        "It's the world's hottest continent and home to the Sahara, the largest hot desert.",
                        "The Nile River is the longest river in the world.",
                        "Over 2,000 different languages are spoken across the continent."
                    ],
                    gallery: [
                        "https://images.unsplash.com/photo-1523805009345-7448845a9e53?q=80&w=2940&auto=format&fit=crop",
                        "https://images.unsplash.com/photo-1547471080-7cc2d5d88e93?q=80&w=2940&auto=format&fit=crop",
                        "https://images.unsplash.com/photo-1516026672322-7cabe1081a2e?q=80&w=2940&auto=format&fit=crop"
                    ],
                    wikiLink: "https://en.wikipedia.org/wiki/Africa"
                },
                {
                    name: "Asia",
                    coords: [40, 100],
                    zoom: 3.5,
                    description: "A giant land of soaring dragons, peaceful temples, and snowy peaks. üêâüå∏",
                    icon: '<svg viewBox="0 0 24 24"><path d="M4 11.97h2.83L12 3l5.17 8.97H20v1.98H4zM12 15.16L9.83 18h4.34L12 15.16z" fill-opacity="0.8"></path></svg>',
                    facts: [
                        "The world's largest and most populous continent, with over 4.5 billion people.",
                        "The birthplace of all the world's major religions.",
                        "Home to the highest point on Earth, Mount Everest.",
                        "The Great Wall of China is the longest wall in the world."
                    ],
                    gallery: [
                        "https://images.unsplash.com/photo-1532274402911-5a369e4c4bb5?q=80&w=2940&auto=format&fit=crop",
                        "https://images.unsplash.com/photo-1583342594633-f16f452455b8?q=80&w=2940&auto=format&fit=crop",
                        "https://images.unsplash.com/photo-1529989333394-4726c04f21e2?q=80&w=2940&auto=format&fit=crop"
                    ],
                    wikiLink: "https://en.wikipedia.org/wiki/Asia"
                },
                {
                    name: "Australia",
                    coords: [-25, 135],
                    zoom: 4,
                    description: "An island of sunshine where kangaroos hop and koalas nap. üê®ü¶ò",
                    icon: '<svg viewBox="0 0 24 24"><path d="M3.5 6C2.2 7.8,2.2,9.6,3.5 11.4c1.3,1.8,3.2,2.7,5.5,2.7c2.3,0,4.2-0.9,5.5-2.7C15.8,9.6,15.8,7.8,14.5,6C13.2,4.2,11.3,3.3,9,3.3 C6.7,3.3,4.8,4.2,3.5,6z" fill-opacity="0.8"></path></svg>',
                    facts: [
                        "The only continent that is also a single country.",
                        "The Great Barrier Reef is the world's largest coral reef system.",
                        "Over 90% of Australians live on the coast.",
                        "It is the only continent without an active volcano."
                    ],
                    gallery: [
                        "https://images.unsplash.com/photo-1524260855046-f743b1cd9045?q=80&w=2940&auto=format&fit=crop",
                        "https://images.unsplash.com/photo-1506973035872-942126b49185?q=80&w=2940&auto=format&fit=crop",
                        "https://images.unsplash.com/photo-1517672120436-3f71c4c2c62e?q=80&w=2940&auto=format&fit=crop"
                    ],
                    wikiLink: "https://en.wikipedia.org/wiki/Australia"
                },
                {
                    name: "Antarctica",
                    coords: [-80, 0],
                    zoom: 3.5,
                    description: "A quiet, frozen kingdom at the bottom of the world, for penguins only! üêß‚ùÑÔ∏è",
                    icon: '<svg viewBox="0 0 24 24"><path d="M12 2l-2.1 6.3L3.6 6.2l4.3 4.3L2 12l6.3 2.1L6.2 20.4l4.3-4.3L12 22l2.1-6.3 6.3 6.3-4.3-4.3L22 12l-6.3-2.1 4.3-4.3-6.3 2.1z" fill-opacity="0.8"></path></svg>',
                    facts: [
                        "The largest desert in the world, despite being covered in ice.",
                        "It holds about 70% of the world's fresh water.",
                        "It is the coldest, windiest, and highest continent on average.",
                        "There are no permanent human residents, only visiting scientists."
                    ],
                    gallery: [
                        "https://images.unsplash.com/photo-1549547432-17e944b33501?q=80&w=2940&auto=format&fit=crop",
                        "https://images.unsplash.com/photo-1588622146638-855b57d0ae66?q=80&w=2940&auto=format&fit=crop",
                        "https://images.unsplash.com/photo-1551415973-e9140415f76f?q=80&w=2940&auto=format&fit=crop"
                    ],
                    wikiLink: "https://en.wikipedia.org/wiki/Antarctica"
                }
            ];

            const welcomeScreen = document.getElementById('welcome-screen');
            const beginButton = document.getElementById('begin-button');
            const mapElement = document.getElementById('map');
            const sidebar = document.getElementById('sidebar');
            const bottomSheet = document.getElementById('bottom-sheet');
            let map;

            beginButton.addEventListener('click', function() {
                // BUG-M-002: Disable button on click to prevent race conditions.
                this.disabled = true;
                welcomeScreen.classList.add('fade-out');
                
                // FIX: [BUG-003] Using 'transitionend' event for robust, decoupled animation handling.
                // The 'once: true' option ensures the listener is automatically removed after firing.
                welcomeScreen.addEventListener('transitionend', () => {
                    welcomeScreen.style.display = 'none';
                    initializeMap();
                    // mapElement.classList.add('visible'); // No longer needed as we don't hide the map div, just cover it
                }, { once: true });
            });

            function initializeMap() {
                const loader = document.getElementById('loader');
                map = L.map('map', {
                    zoomControl: false,
                    attributionControl: false,
                    center: [20, 0],
                    zoom: 2.5,
                    minZoom: 2.5,
                    maxZoom: 7,
                    maxBounds: L.latLngBounds(L.latLng(-90, -180), L.latLng(90, 180)),
                });

                const tileLayer = L.tileLayer('https://tiles.stadiamaps.com/tiles/stamen_watercolor/{z}/{x}/{y}.jpg?api_key=c8301630-e7df-4a9e-84d5-bf5e7453c864', {
                    attribution: '&copy; <a href="https://stadiamaps.com/" target="_blank">Stadia Maps</a>, &copy; <a href="https://stamen.com/" target="_blank">Stamen Design</a> &copy; <a href="https://www.openstreetmap.org/copyright" target="_blank">OpenStreetMap</a>',
                    crossOrigin: true
                });

                // UX-L-001: Show loader when tiles are loading, hide when done.
                tileLayer.on('loading', function() {
                    loader.style.display = 'block';
                });
                tileLayer.on('load', function() {
                    loader.style.display = 'none';
                });

                tileLayer.addTo(map);

                // Add a real-time day/night terminator
                const terminator = L.terminator({
                    fillColor: '#0A2540', // Matches --primary
                    fillOpacity: 0.1,
                    color: 'transparent',
                    resolution: 10
                }).addTo(map);

                // Function to update the terminator's position
                function updateTerminator() {
                    terminator.setTime();
                }

                // Update the terminator every minute
                setInterval(updateTerminator, 60000);
                updateTerminator(); // Initial call

                L.control.attribution({ position: 'bottomleft', prefix: '' }).addTo(map);
                
                // Helper to close all UI
                const closeUI = () => {
                     sidebar.classList.remove('active');
                     bottomSheet.classList.remove('active');
                     // Reset map view
                     map.flyTo([20, 0], 2.5, { animate: true, duration: 1.5 });
                };

                // Close buttons
                document.querySelectorAll('.close-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        closeUI();
                    });
                });

                continents.forEach(continent => {
                    const continentIcon = L.divIcon({
                        className: 'continent-marker',
                        html: `<div class="beacon" role="button" aria-label="${continent.name}" tabindex="0"><div class="beacon-icon">${continent.icon}</div></div>`,
                        iconSize: [40, 40],
                        iconAnchor: [20, 20]
                    });

                    const marker = L.marker(continent.coords, { icon: continentIcon, title: continent.name }).addTo(map);

                    // VULN-C-001: Sanitize dynamic content to prevent XSS.
                    const sanitizedName = sanitizeHTML(continent.name);
                    const sanitizedDesc = sanitizeHTML(continent.description);
                    const galleryHTML = continent.gallery.map(url => `<img src="${url}" alt="Image of ${sanitizedName}" loading="lazy">`).join('');
                    const factsHTML = continent.facts.map(fact =>
                        `<div class="fact-card"><p><strong>Did you know?</strong><br>${sanitizeHTML(fact)}</p></div>`
                    ).join('');

                    const contentHTML = `
                        <div class="gallery-grid">${galleryHTML}</div>
                        <h3>Quick Facts</h3>
                        ${factsHTML}
                        <div style="margin-top: 24px; text-align: center;">
                            <a href="${continent.wikiLink}" target="_blank" rel="noopener noreferrer" style="color: var(--accent); text-decoration: none; font-weight: 600;">Read more on Wikipedia &rarr;</a>
                        </div>
                    `;

                    const populateContent = (titleId, descId, contentId) => {
                        document.getElementById(titleId).textContent = sanitizedName;
                        document.getElementById(descId).textContent = sanitizedDesc;
                        document.getElementById(contentId).innerHTML = contentHTML;
                    };

                    const handleMarkerInteraction = (e) => {
                        L.DomEvent.stopPropagation(e); // Stop map click

                        // Populate Content
                        populateContent('sidebar-title', 'sidebar-desc', 'sidebar-content');
                        populateContent('sheet-title', 'sheet-desc', 'sheet-content');

                        // Determine Layout (Desktop vs Mobile)
                        const isDesktop = window.innerWidth > 768;

                        if (isDesktop) {
                            // Desktop: Fly to allow sidebar space on left
                            // Target point needs to be shifted left in the view, so we fly to a point TO THE RIGHT of the actual coord
                            // Approximate offset: shift longitude by ~40 degrees? Or use projection math.
                            // Simpler: Just fly to the coord for now, but maybe Zoom in more.
                            // Actually, to center the marker in the remaining space (right 2/3rds), we need to center on a point slightly West (left) of the target? No, if sidebar is on Left, the "center" of the view shifts Right.
                            // So the target coordinate should appear to the Right of the screen center.
                            // Meaning the Map Center should be to the Left of the Target.
                            // So we fly to [lat, lng - offset].

                            const offsetLng = -30; // Shift map center West, so target appears East
                            map.flyTo([continent.coords[0], continent.coords[1] + offsetLng], continent.zoom, {
                                animate: true,
                                duration: 1.5,
                                easeLinearity: 0.2
                            });

                            sidebar.classList.add('active');
                            bottomSheet.classList.remove('active');
                        } else {
                            // Mobile: Fly to allow bottom sheet space
                            // Sidebar is on bottom, so we need target to be in top half.
                            // Map Center should be Below the target.
                            // So fly to [lat - offset, lng].
                            const offsetLat = -15;
                            map.flyTo([continent.coords[0] + offsetLat, continent.coords[1]], continent.zoom - 0.5, { // Zoom out a bit for mobile
                                animate: true,
                                duration: 1.2
                            });

                            bottomSheet.classList.add('active');
                            sidebar.classList.remove('active');
                        }
                    };

                    marker.on('click', handleMarkerInteraction);
                    
                    // FIX: [VULN-002] Adding keyboard activation for the marker.
                    marker.on('keyup', (e) => {
                        if (e.originalEvent.key === 'Enter' || e.originalEvent.key === ' ') {
                            handleMarkerInteraction(e);
                        }
                    });
                });

                map.on('click', function(e) {
                    if (e.originalEvent.target.closest('.continent-marker')) return;
                    closeUI();
                });

                // Delightful Surprise: Add a little sailing boat
                function addSailingBoat() {
                    const boatIcon = L.divIcon({
                        className: 'sailing-boat',
                        html: '<svg viewBox="0 0 24 24"><path d="M3.95 19H19.05L12 5.45z M12 3L2 21h20L12 3z" fill="#fefae0" stroke="#0A2540" stroke-width="1.5"></path></svg>',
                        iconSize: [24, 24],
                        iconAnchor: [12, 12]
                    });

                    const boatPath = [
                        [30, -30], [32, -35], [33, -40], [32, -45], [30, -50],
                        [28, -55], [25, -60], [22, -62], [20, -60], [18, -55],
                        [19, -50], [21, -45], [20, -40], [18, -35], [20, -30],
                        [22, -25], [25, -22], [28, -25], [30, -30]
                    ];

                    const boatMarker = L.marker(boatPath[0], { icon: boatIcon }).addTo(map);
                    let currentIndex = 0;
                    let animationFrameId;

                    function animateBoat() {
                        const start = boatPath[currentIndex];
                        const end = boatPath[(currentIndex + 1) % boatPath.length];
                        let startTime = performance.now();

                        function step(now) {
                            const elapsed = now - startTime;
                            const duration = 8000; // 8 seconds per segment
                            const progress = Math.min(elapsed / duration, 1);

                            const lat = start[0] + (end[0] - start[0]) * progress;
                            const lng = start[1] + (end[1] - start[1]) * progress;
                            boatMarker.setLatLng([lat, lng]);

                            if (progress < 1) {
                                animationFrameId = requestAnimationFrame(step);
                            } else {
                                currentIndex = (currentIndex + 1) % boatPath.length;
                                animationFrameId = requestAnimationFrame(animateBoat);
                            }
                        }
                        animationFrameId = requestAnimationFrame(step);
                    }
                    animateBoat();
                }
                addSailingBoat();
            }
        });
    </script>

</body>
</html>
